# gRPC Responder

This is a simple gRPC server implemented in Go that responds with a configurable message and delay. The server can optionally be run with TLS enabled for secure communication.

## Getting Started

### Prerequisites

- `grpcurl` installed for testing the gRPC service
- `openssl` installed for generating TLS certificates

### Building the Project

To build the project, use the following command:

```bash
make build
```

### Running the Server

You can run the server with or without TLS enabled. The behavior of the server can be configured using the following environment variables:

#### Environment Variables

- `PORT`: The port on which the gRPC server will listen. Defaults to `50051`.
- `RESPONSE_DELAY`: The delay in seconds before the server responds. Can be a floating-point number. Defaults to `0`.
- `RESPONSE_MESSAGE`: The message the server will respond with. Defaults to `"Hello from Kedify"`.
- `TLS_ENABLED`: Set to `true` to enable TLS. Defaults to `false`.
- `TLS_CERT_FILE`: The path to the TLS certificate file. Required if `TLS_ENABLED` is `true`.
- `TLS_KEY_FILE`: The path to the TLS key file. Required if `TLS_ENABLED` is `true`.

#### Running Without TLS

To run the server without TLS, simply execute:

```bash
make run
```

This will start the server on the default port `50051` with the default message and no delay.

#### Running with TLS

To run the server with TLS enabled, execute:

```bash
make run TLS_ENABLED=true
```

This command will generate the necessary TLS certificates, start the server with TLS enabled, and use the default port `50051`.

### Testing the Server with grpcurl

You can test the server using `grpcurl`. Below are examples for both TLS-enabled and TLS-disabled scenarios.

#### Testing Without TLS

If TLS is not enabled, you can test the server with the following `grpcurl` command:

```bash
grpcurl -plaintext -d '{"name": "Test"}' localhost:50051 responder.HelloService/SayHello
```

#### Testing with TLS

If TLS is enabled, use the following `grpcurl` command:

```bash
grpcurl -d '{"name": "Test"}' -cacert server.crt localhost:50051 responder.HelloService/SayHello
```

This command assumes that `server.crt` is the certificate file generated by the `Makefile` during the `make run` command.

### Cleaning Up

To clean up the generated files, including the binary and TLS certificates, run:

```bash
make clean
```

## k3d Setup

To set up the k3d cluster with the necessary configurations and install the NGINX Ingress Controller, follow these steps:

1. **Create and Configure the k3d Cluster**:

   First, delete any existing k3d clusters and create a new one with ports configured for HTTP and HTTPS, and disable Traefik:

   ```bash
   k3d cluster create --port "9080:80@loadbalancer" --port "9443:443@loadbalancer" --k3s-arg "--disable=traefik@server:*"
   ```

2. **Install NGINX Ingress Controller**:

   Add the Helm repository for ingress-nginx and update the Helm repository list:

   ```bash
   helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
   helm repo update
   ```

   Install the NGINX Ingress Controller in the `nginx-ingress` namespace:

   ```bash
   helm install nginx-ingress ingress-nginx/ingress-nginx \
     --namespace nginx-ingress \
     --create-namespace \
     --set controller.publishService.enabled=true \
     --set controller.service.type=LoadBalancer
   ```

   Watch the service to ensure it's running correctly:

   ```bash
   kubectl get service --namespace nginx-ingress nginx-ingress-ingress-nginx-controller --output wide --watch
   ```

### Testing without TLS on k3d

1. **Disable TLS in the Deployment**:

   In your deployment configuration (`config/app.yaml`), disable TLS by setting the `TLS_ENABLED` environment variable to `false`:

   ```yaml
   - name: TLS_ENABLED
     value: "false"
   ```

2. **Apply the Configuration**:

   Apply the application and ingress configurations:

   ```bash
   kubectl apply -f config/app.yaml
   kubectl apply -f config/ingress.yaml
   ```

3. **Update `/etc/hosts`**:

   Add `grpc.keda` to your `/etc/hosts` file, pointing to `localhost`:

   ```
   127.0.0.1 grpc.keda
   ```

4. **Run the Test**:

   Test the gRPC service using `grpcurl`:

   ```bash
   grpcurl -plaintext -d '{"name": "Test"}' grpc.keda:9080 responder.HelloService/SayHello
   ```

   You should receive a response similar to:

   ```json
   {
     "message": "Hello from Kedify"
   }
   ```

### Testing with TLS on k3d

1. **Enable TLS in the Deployment**:

   In your deployment configuration (`config/app.yaml`), enable TLS by setting the `TLS_ENABLED` environment variable to `true`:

   ```yaml
   - name: TLS_ENABLED
     value: "true"
   ```

2. **Apply the Configuration**:

   Apply the updated application and TLS-enabled ingress configurations:

   ```bash
   kubectl apply -f config/app.yaml
   kubectl apply -f config/ingress-tls.yaml
   ```

3. **Update `/etc/hosts`**:

   Ensure that `grpc.keda` is correctly mapped to `localhost` in your `/etc/hosts` file:

   ```
   127.0.0.1 grpc.keda
   ```

4. **Run the Test**:

   Test the gRPC service with TLS using `grpcurl`:

   ```bash
   grpcurl -d '{"name": "Test"}' -cacert server.crt grpc.keda:9443 responder.HelloService/SayHello
   ```

   You should receive a response like:

   ```json
   {
     "message": "Hello from Kedify"
   }
   ```
